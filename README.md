# IMPERIAL

### Описание
Телеграм-бот для футбольного клуба "Империал", созданный для автоматизация процессов связанных с регулярно-повторяющимися действиями: создание голосований, редактирование информации, отображение статистики по играм, игрокам и др. 
### Технологии
`Aiogram` `SQLAlchemy` `AsyncIOScheduler` `apscheduler-di` `aioredis` `aioEasyPillow` `aiofiles` `aiohttp` `aiogram-calendar-rus` `bs4`

#### Функциональность
```
1. Команды для администратора:
   1. /change_about - изменеие описания клуба
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Бот запрашивает ввод нового текста для записи в БД (таблица: About).
     * Возможность отмены действия.
   2. /change_rules - изменеие правил клуба
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Бот запрашивает ввод нового текста для записи в БД (таблица: Rule).
     * Возможность отмены действия.
   3. /task_scheduler - планировщик событий на выбранный период, тип: "Голосования"
     * Технологии: apscheduler, apscheduler-di, aigoram-calendar, redis;
     - Функциональность:
       - Создание, изменение, удаление события;
       - 3 вида событий (Игра, Тренировка, Тренировка 2);
       - Поля для создания: описание, день, дата начала, дата конца;
       - Изменение события аналогично "создания" события;
       - Удаление выбранного события;
       - Ограничение. Появлется соответсвующее вспылывающее сообщение, если был уже затронут (удален или создан) данный тип события.
       * Запуск по тригерру cron, по умолчанию раз в неделю в заранее установленное время.
       * Возможность отмены действия.
       * С помощью DockerCompose поднят сервис в качестве redis (хранилища) для задач apscheduler
     * Данные проведённых голосованиях хранятся в БД (таблица: Poll)
     * Данные о проголосовавших хранятся в БД (таблица: UserPoll)
   4. /users - вывод списка пользователей из БД (таблица: User)
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Представленные поля: ФИО, дата рождения, телефон, telegram_id
   5. /user_manager - создание / редактирование / удаление пользователя
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg
     - Создание. Добавление нового пользователя проходит в 6 шагов с помощью Aiogram FSMCOntext, данные, которые необходимо передать боту:
        1. telegram_id или сообщения от пользователя, откуда бот вычленит telegram_id;
        2. ФИО. Через пробел фамилия, имя и отчество. 3 параметр не является обязательным;
        3. Дата рождения в формате: 01/01/1999. Допустимо вместо слеша использовать другие разделители: "." или "-"
        4. Телефон в формате: +79997775533. Допустимо указывать другие символы: +() -. Необходимо учитывать, что первый символ заменяется на "7";
        5. Амплуа игрока укащывается в 3 символах вернего регистра: ЗАЩ, ПЗЩ, ВРТ, НАП, ЦЗ, ЛЗ, ПЗ, ЦПЗ, ЛПЗ, ППЩ;
        6. Фото игрока.
     - Редактирование. Изменение информации доступно с помощью кнопок inline-клавиатуры Aiogram. Порядок действий:
        1. Выбор пользователя из динамической inline-клавиатуры;
        2. Выбор нужного поля: имя, фамилия, отчество, дата рождения, фото профиля, позиция, клуб, телефон, телеграм id;
     - Удаление.
        - Удаление игрока прооисходит после выбор пользователя из динамической inline-клавиатуры;
        * Восстановление пользователя только через добавление нового пользователя.
     * Динамическая клавиатура со списком игроков генерируется с использованием бд (таблица: User), по умолчанию обновление данных раз в неделю или после добавления нового пользователя.
     * Данные хранятся в БД (таблица: User).
     * Возможность отмены действия.
2. Пользовательские команды:
   1. /about - описание клуба
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Вывод содержимого текста из БД (таблица: About)
   2. /rules - правила клуба
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Вывод содержимого текста из БД (таблица: Rule)
   3. /tournament_table - статистика турнира
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Выбор формата игры и вывод изображения с актуальной информацией по турнире из БД (таблица: TournamentTable).
     * Динамическая клавиатура со списком турниров генерируется с использованием бд (таблица: Tournament), по умолчанию обновление данных раз в неделю.
     * Возможность отмены действия.
     * Изображение генерируется заранее и хранится в директории /media
   4. /team - карточка игрока;
     * Технологии: SqlAlchemy, PostgreSQl, asyncpg;
     - Выбор игрока и вывод изображения с актуальной информацией по игроку (карточка игрока).
     - Карточка игрока содержит данные: аватарка, ФИО, амплуа, дата рождения, возраст, день рождения, сводная информация в турнире (ах).
     * Возможность отмены действия.
     * Динамическая клавиатура со списком игроков генерируется с использованием бд (таблица: User), по умолчанию обновление данных раз в неделю или после добавления нового пользователя.
     * Изображение генерируется заранее и хранится в директории /media
3. Парсер для сбора данных из турнирной таблицы и генерации изображения по турниру
    * Технологии: apscheduler, apscheduler-di, aiohtttp, aiofiles, aioEasyPillow, SqlAlchemy, PostgreSQl, asyncpg
    Принцип работы парсера для сбора и генерации изображения по статистики турнира:
    - Парсер по заданной ссылке в указанный период собирает данные и сохраняет их в БД (таблицы: Tournament, TournamentTable);
    - Обновление данных происходит только в таблице: TournamentTable;
    - Далее данные передаются в функию: show_table_tournament для обработки изображений (c помощью pillow) для генерации изображения с актуальной информацией статистики турнира (команда /tournament_table);
    - Иозображение сохраняется или перезаписывается с актуальной информацией в директорию /meida/tournament_table;
    - По умолчанию с помощью apscheduler обновление раз в неделю.  
4. Парсер для сбора данных по команде и генерации изображения по каждому члену команды
    * Технологии: apscheduler, apscheduler-di, aiohtttp, aiofiles, aioEasyPillow, SqlAlchemy, PostgreSQl, asyncpg
    Принцип работы парсера для сбора данных и генерации изображения по каждому участнику турнира:
    - Парсер по заданной ссылке в указанный период собирает данные и сохраняет их в БД (таблицы: User, Player);
    - Обновление данных происходит только в таблице: Player, в заданный период проведения турнира;
    - Далее данные передаются в функию: show_table_player для обработки изображений (c помощью pillow) для генерации изображения с актуальной информацией по игроку (команда /team);
    - Иозображение сохраняется или перезаписывается с актуальной информацией в директорию /meida/player_card/name_player;
    - По умолчанию с помощью apscheduler обновление раз в неделю.
* Обновление данных происходит в течении всего периода проведения турнира, кроме 1 раза, когда турнир был создан и требуется явная запись.
* Очищение зранилища от **базовых задач** apscheduler после перезапуска бота;
```

#### Запуск проекта в Docker:
```
Приложение имеет настроенный рабочий файл Docker-compose.yml и запускается в 3х контейнерах:
    - postgres:11.0-alpine (сервис postgres)
    - redis:6.2-alpine (сервис хранилище для scheduler)
    - imperial_bot:v1.0.0 (backend)
```
**_Установить на сервере Docker, Docker Compose_**
```
sudo apt install curl                                   - установка утилиты для скачивания файлов
curl -fsSL https://get.docker.com -o get-docker.sh      - скачать скрипт для установки
sh get-docker.sh                                        - запуск скрипта
sudo apt-get install docker-compose-plugin              - последняя версия docker compose
**_В корне проекта переименовать .env.dist в .env и по желанию изменить название BOT_CONTAINER_NAME, BOT_IMAGE_NAME, BOT_NAME_**
Обязательные поля для заполнения:
    - Настройка бота: BOT_TOKEN (токен бота), ADMINS (telegram_id(s) для управления ботом), GROUP (поллинг опросов)
    - БД для хранилища данных: DB_USER, DB_PASS, DB_NAME, DP_PORT, DB_HOST
    - БД для хранилища задач: REDIS_HOST, REDIS_PORT, REDIS_DB, REDIS_PASSWORD
```
**_Скопировать на сервер файлы docker-compose.yml, .env. Команды выполняются из корня проекта._**
```
scp docker-compose.yml .env username@IP:/home/username/
# username - имя пользователя на сервере
# IP - публичный IP сервера
```
#### Клонировать репозиторий, если нет готового файла на docker_hub и перейти в него в командной строке:
```
git clone https://github.com/krivse/bot_imperial.git
```
**_Создать и запустить контейнеры Docker_**
```angular2html
sudo docker compose up -d
```
**_Для остановки контейнеров Docker:_**
```
sudo docker compose down -v      - с их удалением
sudo docker compose stop         - без удаления
```

### Как запустить проект вне Docker:

#### Клонировать репозиторий и перейти в него в командной строке:

```
git clone https://github.com/krivse/bot_imperial.git
```

#### Cоздать и активировать виртуальное окружение:

```
python3 -m venv venv
```

```
# для OS Lunix и MacOS
source venv/bin/activate

# для OS Windows
source venv/Scripts/activate
```

#### Установить зависимости из файла requirements.txt:

```
python3 -m pip install --upgrade pip
pip install -r requirements.txt
```
#### Запустить проект:
```angular2html
Переименовать файл .env.dist -> .env. 
Обязательные поля для заполнения:
    - Настройка бота: BOT_TOKEN (токен бота), ADMINS (telegram_id(s) для управления ботом), GROUP (поллинг опросов)
    - БД для хранилища данных: DB_USER, DB_PASS, DB_NAME, DP_PORT, DB_HOST
    - БД для хранилища задач: REDIS_HOST, REDIS_PORT, REDIS_DB, REDIS_PASSWORD

Запустить с помощью команды: python bot.py
```

###### Ivan Krasnikov
